name: Train Model

on:
  workflow_dispatch:
    inputs:
      dataset_url:
        description: 'Dataset URL (Kaggle or direct download)'
        required: false
        default: 'kaggle://farjanakabirsamanta/skin-cancer-dataset'
        type: string

jobs:
  train:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Download dataset
        env:
          KAGGLE_API_TOKEN: ${{ secrets.KAGGLE_API_TOKEN }}
          DATASET_URL: ${{ inputs.dataset_url || 'kaggle://farjanakabirsamanta/skin-cancer-dataset' }}
        run: |
          mkdir -p data
          if [[ "$DATASET_URL" == kaggle://* ]]; then
            pip install -q kaggle
            DATASET="${DATASET_URL#kaggle://}"
            kaggle datasets download -d "$DATASET" -p data/ --unzip
          else
            curl -L "$DATASET_URL" -o dataset.zip
            unzip dataset.zip -d data/
            rm dataset.zip
          fi

      - name: Run training
        id: train
        env:
          PYTHONPATH: .
        run: |
          # Use sample mode for auto-triggered runs, full dataset for manual
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            python scripts/train.py 2>&1 | tee training.log
          else
            python scripts/train.py --sample 500 2>&1 | tee training.log
          fi
          echo "## Training Results" >> $GITHUB_STEP_SUMMARY

      - name: Generate summary
        if: always()
        run: |
          echo "### Environment" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Runner | \`ubuntu-24.04-arm\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Python | \`$(python --version)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| PyTorch | \`$(python -c 'import torch; print(torch.__version__)')\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          cat configs/config.yaml >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Training Log" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat training.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Extract results table if present
          if grep -q "RESULTS" training.log; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Results" >> $GITHUB_STEP_SUMMARY
            sed -n '/--- RESULTS ---/,/^$/p' training.log | tail -n +2 >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          path: |
            results/cache/classifier.pkl
            results/cache/embeddings.pt
          retention-days: 7
